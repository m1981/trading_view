//@version=5
indicator("Mean Reversion Strategy (Daily Timeframe)", overlay=true)

// Parameters
ma_200_length = input.int(200, "MA 200 Length")
ma_20_length = input.int(20, "MA 20 Length")
bb_std_mult = input.float(2.0, "Bollinger Bands StdDev Multiplier")
rsi_length = input.int(2, "RSI Length")
price_change_period = input.int(150, "Price Change Period (Days)")
max_hold_days = input.int(10, "Maximum Hold Days")
limit_order_pct = input.float(3.0, "Limit Order Percent Below", minval=0.1, step=0.1)

// Force daily timeframe for all calculations
[daily_close, daily_high, daily_low, daily_open] = request.security(syminfo.tickerid, "D", [close, high, low, open])

// Calculate indicators using daily data
daily_ma_200 = request.security(syminfo.tickerid, "D", ta.sma(close, ma_200_length))
daily_ma_20 = request.security(syminfo.tickerid, "D", ta.sma(close, ma_20_length))
daily_bb_std = request.security(syminfo.tickerid, "D", ta.stdev(close, ma_20_length))
daily_bb_lower = daily_ma_20 - (bb_std_mult * daily_bb_std)
daily_rsi_2 = request.security(syminfo.tickerid, "D", ta.rsi(close, rsi_length))

// Calculate price change over specified period (daily timeframe)
daily_price_change_150d = request.security(syminfo.tickerid, "D", close / close[price_change_period] - 1)

// Volume analysis
daily_volume = request.security(syminfo.tickerid, "D", volume)
daily_volume_sma = request.security(syminfo.tickerid, "D", ta.sma(volume, 20))
volume_ratio = daily_volume / daily_volume_sma

// Enhanced entry conditions with volume
volume_confirmation = volume_ratio > 1.2  // Above average volume on pullback
daily_buy_limit_price = daily_close * (1 - limit_order_pct/100)  // Limit order price

// Market regime filter
vix = request.security("VIX", "D", close)
vix_sma = request.security("VIX", "D", ta.sma(close, 20))
low_fear_environment = vix < vix_sma * 1.2  // VIX not spiking

// Sector relative strength (using SPY as benchmark)
spy_close = request.security("SPY", "D", close)
spy_sma20 = request.security("SPY", "D", ta.sma(close, 20))
stock_vs_spy = (daily_close / daily_close[20]) / (spy_close / spy_close[20])
sector_strength = stock_vs_spy > 1.0  // Outperforming market

// Final buy signal with all filters
daily_buy_signal = daily_uptrend and daily_pullback and volume_confirmation and low_fear_environment and sector_strength

// Calculate days held (needs to be tracked across timeframes)
var float last_buy_time = 0.0
var int days_held = 0

// Get current day
current_day_time = request.security(syminfo.tickerid, "D", time)
is_new_day = current_day_time != last_buy_time and not na(current_day_time)

if (daily_buy_signal and (days_held == 0 or is_new_day))
    days_held := 1
    last_buy_time := current_day_time
else if (days_held > 0 and is_new_day)
    days_held := days_held + 1

// Enhanced exit conditions
var float entry_price = na
var float trailing_stop = na

if daily_buy_signal and days_held == 0
    entry_price := daily_close
    trailing_stop := entry_price * 0.95  // 5% initial stop

// Update trailing stop
if days_held > 0 and daily_close > entry_price * 1.02  // If up 2%
    new_stop = daily_close * 0.98  // 2% trailing stop
    trailing_stop := math.max(trailing_stop, new_stop)

// Enhanced sell conditions
daily_stop_loss = daily_close < trailing_stop
daily_profit_target = daily_close > entry_price * 1.08  // 8% profit target
daily_sell_signal = (daily_rsi_exit or daily_time_exit or daily_stop_loss or daily_profit_target) and days_held > 0

// Reset days_held when selling
if (daily_sell_signal and is_new_day)
    days_held := 0

// Plotting
plot(daily_ma_200, "200-day MA", color.rgb(255, 165, 0), 2)
plot(daily_ma_20, "20-day MA", color.rgb(0, 128, 255), 1)
plot(daily_bb_lower, "Lower Bollinger Band", color.rgb(255, 0, 0), 1)

// Plot buy and sell signals
plotshape(daily_buy_signal, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(daily_sell_signal, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)

// Enhanced status display
if (barstate.islast)
    status_text = "Enhanced Mean Reversion:\n"
    status_text += "Uptrend: " + (daily_uptrend ? "✓" : "✗") + "\n"
    status_text += "Pullback: " + (daily_pullback ? "✓" : "✗") + "\n"
    status_text += "Volume: " + str.tostring(volume_ratio, "#.##") + "x\n"
    status_text += "VIX Filter: " + (low_fear_environment ? "✓" : "✗") + "\n"
    status_text += "Sector Strength: " + (sector_strength ? "✓" : "✗") + "\n"
    status_text += "Days Held: " + str.tostring(days_held) + "\n"
    if not na(entry_price) and days_held > 0
        pnl_pct = (daily_close / entry_price - 1) * 100
        status_text += "P&L: " + str.tostring(pnl_pct, "#.##") + "%"
    
    color label_color = na
    if (days_held > 0 and not daily_sell_signal)
        label_color = color.green
    else if (daily_buy_signal)
        label_color = color.green
    else
        label_color = color.gray
        
    if (not na(status_label))
        label.delete(status_label)
    
    status_label := label.new(bar_index, high, status_text,color=color.new(color.black, 20),textcolor=label_color,style=label.style_label_down,yloc=yloc.abovebar)

// Create a table to show strategy details
var table strategy_info = table.new(position.top_right, 3, 7, bgcolor = color.new(color.black, 70), border_width=1)

if (barstate.isfirst)
    table.cell(strategy_info, 0, 0, "Mean Reversion Strategy", text_color=color.white, bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.cell(strategy_info, 0, 1, "(Daily Timeframe Data)", text_color=color.white, bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.cell(strategy_info, 0, 2, "Buy Conditions:", text_color=color.white, text_size=size.small)
    table.cell(strategy_info, 0, 3, "1. Price > 200 MA", text_color=color.white, text_size=size.small)
    table.cell(strategy_info, 0, 4, "2. Price < Lower BB", text_color=color.white, text_size=size.small)
    table.cell(strategy_info, 0, 5, "Sell Conditions:", text_color=color.white, text_size=size.small)
    table.cell(strategy_info, 0, 6, "1. RSI(2) > 50 or 10 days held", text_color=color.white, text_size=size.small)

// Alert conditions
alertcondition(daily_buy_signal, "Buy Signal", "Mean Reversion Strategy: Buy Signal")
alertcondition(daily_sell_signal, "Sell Signal", "Mean Reversion Strategy: Sell Signal")
