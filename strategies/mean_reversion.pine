//@version=5
strategy("Mean Reversion Strategy (Daily Timeframe)",
   overlay=true,
   default_qty_type=strategy.percent_of_equity,
   default_qty_value=100,
   commission_type=strategy.commission.percent,
   commission_value=0.1,
   slippage=2,
   initial_capital=10000,
   currency=currency.USD,
   pyramiding=0,
   calc_on_every_tick=false,
   process_orders_on_close=true)

// Strategy Parameters
start_date = input.time(timestamp("2018-01-01"), "Start Date")
end_date = input.time(timestamp("2099-12-31"), "End Date")
use_date_filter = input.bool(true, "Use Date Filter")
enable_long = input.bool(true, "Enable Long Trades")

// Trading Parameters
ma_200_length = input.int(200, "MA 200 Length", group="Indicators")
ma_20_length = input.int(20, "MA 20 Length", group="Indicators")
bb_std_mult = input.float(2.0, "Bollinger Bands StdDev Multiplier", group="Indicators")
rsi_length = input.int(2, "RSI Length", group="Indicators")
max_hold_days = input.int(10, "Maximum Hold Days", group="Trade Management")
limit_order_pct = input.float(3.0, "Limit Order Percent Below", minval=0.1, step=0.1, group="Trade Management")
trailing_stop_trigger = input.float(2.0, "Trailing Stop Trigger (%)", group="Trade Management")
trailing_stop_pct = input.float(2.0, "Trailing Stop (%)", group="Trade Management")
profit_target = input.float(8.0, "Profit Target (%)", group="Trade Management")
stop_loss = input.float(5.0, "Stop Loss (%)", group="Trade Management")

// Time filter
in_date_range = not use_date_filter or (time >= start_date and time <= end_date)

// Calculate indicators directly (no need for request.security since we're using timeframe="D")
ma_200 = ta.sma(close, ma_200_length)
ma_20 = ta.sma(close, ma_20_length)
bb_std = ta.stdev(close, ma_20_length)
bb_lower = ma_20 - (bb_std_mult * bb_std)
rsi_2 = ta.rsi(close, rsi_length)

// Core entry conditions
uptrend = close > ma_200
pullback = close < bb_lower

// Volume analysis
volume_sma = ta.sma(volume, 20)
volume_ratio = volume / volume_sma

// Final buy signal
buy_signal = uptrend and pullback and enable_long

// Calculate days held
var float last_buy_time = 0.0
var int days_held = 0
var float entry_price = na

// Track new days
is_new_day = time != last_buy_time and not na(time)

// Exit conditions
rsi_exit = rsi_2 > 50
time_exit = days_held >= max_hold_days
sell_signal = (rsi_exit or time_exit) and days_held > 0

// Position management logic
if (strategy.position_size > 0)
    // Update days held
    if (is_new_day)
        days_held := days_held + 1

    // Exit signals
    if (sell_signal and is_new_day)
        strategy.close("MeanReversion", comment="Exit Signal")
        days_held := 0
        entry_price := na
else
    days_held := 0

// Entry logic
if (buy_signal and strategy.position_size == 0 and in_date_range)
    entry_price := close
    days_held := 1
    last_buy_time := time
    limit_price = close * (1 - limit_order_pct/100)
    strategy.entry("MeanReversion", strategy.long, limit=limit_price, comment="Buy Signal")

    // Set profit target and stop loss
    strategy.exit("Take Profit/Stop Loss", "MeanReversion",
                 profit=strategy.position_avg_price * profit_target / 100,
                 loss=strategy.position_avg_price * stop_loss / 100)

// Apply trailing stop if position is profitable enough
if (strategy.position_size > 0 and strategy.position_avg_price > 0)
    current_profit_pct = (close - strategy.position_avg_price) / strategy.position_avg_price * 100

    if (current_profit_pct >= trailing_stop_trigger)
        strategy.exit("Trailing Stop", "MeanReversion",
                     trail_price=strategy.position_avg_price * (1 + trailing_stop_trigger/100),
                     trail_offset=close * trailing_stop_pct/100)

// Plotting
plot(ma_200, "200-day MA", color.rgb(255, 165, 0), 2)
plot(ma_20, "20-day MA", color.rgb(0, 128, 255), 1)
plot(bb_lower, "Lower Bollinger Band", color.rgb(255, 0, 0), 1)

// Plot buy and sell signals
plotshape(strategy.position_size == 0 and buy_signal, "Buy Signal", shape.triangleup, location.belowbar, color.green, size=size.small)
plotshape(strategy.position_size > 0 and sell_signal, "Sell Signal", shape.triangledown, location.abovebar, color.red, size=size.small)
